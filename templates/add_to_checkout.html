document.addEventListener('DOMContentLoaded', function() {
    // Ensure CSRF token is included in headers
    const csrf_token = document.getElementById('csrf_token').value;

    // Dynamic item creation
    const items = {
        1: {'title': 'Ancient Vase', 'price': 25, 'image': 'https://collectionapi.metmuseum.org/api/collection/v1/iiif/248902/541985/main-image'},
        2: {'title': 'Renaissance Painting', 'price': 30, 'image': 'https://cdn.shopify.com/s/files/1/1414/2472/files/1-_604px-Mona_Lisa__by_Leonardo_da_Vinci__from_C2RMF_retouched.jpg?v=1558424691'},
        3: {'title': 'Ancient Sculpture', 'price': 20, 'image': 'https://cdn.sanity.io/images/cctd4ker/production/1aa8046e23e93e92b205aae6be6480549b9c7ca1-1440x960.jpg?w=3840&q=75&fit=clip&auto=format'},
        4: {'title': 'Impressionist Artwork', 'price': 15, 'image': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSlC9suapfI1YOZYafNsa_N-0DlDAaXpha6YA&s'}
    };

    // Dynamically render the items
    const itemsContainer = document.getElementById("items-container");
    Object.keys(items).forEach(itemId => {
        const item = items[itemId];
        const itemHTML = `
            <div class="item">
                <h3>${item.title}</h3>
                <p>Price: $${item.price}</p>
                <img src="${item.image}" alt="${item.title}" width="200">
                <!-- Add to Cart Button -->
                <button id="add-to-cart-btn-${itemId}" data-item-id="${itemId}">Add to Cart</button>
                <!-- Add to Checkout Button -->
                <button class="add-to-checkout-btn" data-item-id="${itemId}">Add to Checkout</button>
            </div>
        `;
        itemsContainer.innerHTML += itemHTML;

        // Add to Cart Button functionality
        document.getElementById(`add-to-cart-btn-${itemId}`).addEventListener("click", function() {
            const itemId = this.getAttribute("data-item-id");

            fetch(`/add_to_cart/${itemId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrf_token  // CSRF token for security
                },
                body: JSON.stringify({ "item_id": itemId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message); 
                } else {
                    alert(data.message); 
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while adding to the cart.");
            });
        });

        // Add to Checkout Button functionality
        document.querySelector(`.add-to-checkout-btn[data-item-id="${itemId}"]`).addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const quantity = 1;  // Set the default quantity for adding to checkout (can be dynamic if needed)

            fetch('/add_to_checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token  // CSRF token for security
                },
                body: JSON.stringify({ item_id: itemId, quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);  // Success message
                } else {
                    alert('Failed to add item to checkout.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding to checkout.');
            });
        });
    });
});
